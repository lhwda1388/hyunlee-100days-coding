<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Traffic Light</title>
</head>
<body>
<canvas id='c'></canvas>

<script>
    var width, height;
    width = window.innerWidth;
    height = window.innerHeight;
    var cv = document.getElementById('c');
    var ctx = cv.getContext('2d');
    var ctnX, ctnY;
    var trafficLight;
    var red, yellow, green;
    var rightCicleInfo = {
        bright : [10, 50],
        brightList : ['r', 'y', 'g'],
        curBirightIdx : 0
    };


    var TrafficLight = function (ctx, x, y, w, h, bColor) {
        this.ctx = ctx;
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
        this.r = w / 3.3;
        this.lrr = ( (this.w + (this.r) ) / 3  );
        this.bColor = bColor;

    };

    TrafficLight.prototype = {

        draw : function () {
            var ctx = this.ctx;
            var x = this.x, y = this.y, w = this.w, h = this.h, r = this.r , bColor = this.bColor;
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle = bColor;

            ctx.moveTo(x, y);
            ctx.lineTo(x + w, y);
            ctx.bezierCurveTo(x + w + r, y, x + w + r, y + h, x + w, y + h);
            ctx.lineTo(x, y + h);
            ctx.bezierCurveTo(x - r, y + h, x - r, y, x, y);
            ctx.lineWidth = 5;

            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }

    };

    var LightCircle = function (ctx, x, y, w, h, bColor, delay) {
        TrafficLight.call(this, ctx, x, y, w, h, bColor);
        this.hslH = 0;
        this.hslS = 0;
        this.hslL = 0;
        this.delay = delay;
        this.remainTime = delay;
        this.rX = getLightX(this.lrr, this.x, this.r, 1);
        this.yX = getLightX(this.lrr, this.x, this.r, 2);
        this.gX = getLightX(this.lrr, this.x, this.r, 3);
        this.curBright = 10;
        this.ryg = 'r';
    };

    LightCircle.prototype = Object.create(TrafficLight.prototype);

    LightCircle.prototype = {
        update : function (h, s, ryg) {

            this.ryg = ryg;


            console.log(rightCicleInfo.brightList[rightCicleInfo.curBirightIdx]);


            console.log(this.ryg + ", " + this.remainTime);

            this.hslH = h;
            this.hslS = s;
            this.hslL = this.curBright

            if (this.ryg == rightCicleInfo.brightList[rightCicleInfo.curBirightIdx]) {

                this.remainTime = this.remainTime - 1;

                if (this.remainTime > 0 && this.remainTime <= 5) {
                    this.curBright = this.curBright == rightCicleInfo.bright[0] ? rightCicleInfo.bright[1] : rightCicleInfo.bright[0];
                } else {
                    this.curBright = rightCicleInfo.bright[1];

                    if (this.remainTime <= 0) {

                        if (rightCicleInfo.brightList.length - 1 == rightCicleInfo.curBirightIdx) {
                            rightCicleInfo.curBirightIdx = 0;
                            this.remainTime = this.delay;
                            this.curBright = rightCicleInfo.bright[0];
                        } else {
                            rightCicleInfo.curBirightIdx = rightCicleInfo.curBirightIdx + 1;
                            this.remainTime = this.delay;
                            this.curBright = rightCicleInfo.bright[0];
                        }

                    }

                }

            } else {

                this.curBright = rightCicleInfo.bright[0];

            }


        },
        draw : function () {
            var ctx = this.ctx;
            var lr = this.lrr / 2;
            var y = this.y + ( (this.h - (lr * 2)) / 2 );
            var x;

            switch (this.ryg) {
                case 'r' :
                    x = this.rX;
                    break;
                case 'y' :
                    x = this.yX;
                    break;
                case 'g' :
                    x = this.gX;
                    break;
                default :
                    x = this.x;
                    break;

            }

            ctx.save();
            ctx.beginPath();
            ctx.rect(x, y, lr * 2, lr * 2);
            ctx.lineWidth = 4;
            ctx.closePath();
            ctx.stroke();

            ctx.beginPath();
            ctx.fillStyle = 'hsl('+ this.hslH +', '+ this.hslS +'%, '+ this.hslL +'% )';
            ctx.arc(x + lr, y + lr, lr, 0 , 2 * Math.PI, false);
            ctx.fill();
            ctx.closePath();
            ctx.stroke();

            ctx.restore();
        }
    };


    var getLightX = function (lrr, x, r, sort) {
        return ( (lrr * sort) - lrr ) + (x - lrr / 3);
    };

    var initSize = function () {
        cv.width = width;
        cv.height = height;
        ctnX = width / 2;
        ctnY = height / 2;

    };

    var init = function () {
        trafficLight = new TrafficLight(ctx, ctnX - (cv.width/4/2) , ctnY - (cv.height/4/2), cv.width/4, cv.height/ 4, '#3E3E40');
        red = new LightCircle(ctx, trafficLight.x, trafficLight.y, trafficLight.w, trafficLight.h, trafficLight.bColor, 10);
        yellow = new LightCircle(ctx, trafficLight.x, trafficLight.y, trafficLight.w, trafficLight.h, trafficLight.bColor, 6);
        green = new LightCircle(ctx, trafficLight.x, trafficLight.y, trafficLight.w, trafficLight.h, trafficLight.bColor, 12);
    };

    var draw = function () {
        ctx.clearRect(0, 0, cv.width, cv.height);
        trafficLight.draw();

        red.update(360, 100, rightCicleInfo.brightList[0]);
        red.draw();

        yellow.update(54, 100, rightCicleInfo.brightList[1]);
        yellow.draw();

        green.update(118, 100, rightCicleInfo.brightList[2]);
        green.draw();
    };

    var loop = function () {
        draw();
    };

    initSize();
    init();
    loop();
    setInterval(loop, 1000);

    window.addEventListener('resize', initSize);
</script>
</body>
</html>
